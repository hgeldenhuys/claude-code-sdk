{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://claude-loom.dev/schemas/story.schema.json",
  "title": "Loom Story",
  "description": "Comprehensive story file serving as the primary communication channel between actors. This is the 'digital story card' that travels with the work, containing context, tasks, handoffs, and audit trail.",
  "type": "object",
  "required": ["id", "title", "status", "context", "acceptanceCriteria", "tasks", "actorSections", "history"],
  "properties": {
    "id": {
      "type": "string",
      "description": "Unique story identifier in format {FEATURE_CODE}-{nnn}",
      "pattern": "^[A-Z]+-[0-9]{3}$",
      "examples": ["US-014", "FEAT-002", "AUTH-001"]
    },
    "title": {
      "type": "string",
      "description": "Human-readable story title",
      "minLength": 5,
      "maxLength": 100
    },
    "status": {
      "type": "string",
      "description": "Current story status",
      "enum": ["planned", "in-progress", "completed", "blocked"]
    },
    "priority": {
      "type": "string",
      "description": "Priority level for backlog ordering",
      "enum": ["P0", "P1", "P2", "P3"],
      "default": "P1"
    },
    "feature": {
      "type": "string",
      "description": "Feature code this story belongs to",
      "pattern": "^[A-Z]+$",
      "examples": ["AUTH", "DASH", "NOTIFY"]
    },
    "context": {
      "$ref": "#/definitions/Context",
      "description": "Business context explaining why this story exists"
    },
    "acceptanceCriteria": {
      "type": "array",
      "description": "List of testable acceptance criteria",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/AcceptanceCriterion"
      }
    },
    "tasks": {
      "type": "array",
      "description": "Atomic tasks that implement this story",
      "items": {
        "$ref": "#/definitions/Task"
      }
    },
    "actorSections": {
      "type": "object",
      "description": "Per-actor handoff sections - the communication artifacts",
      "additionalProperties": {
        "$ref": "#/definitions/ActorSection"
      },
      "propertyNames": {
        "enum": ["architect", "backend-dev", "frontend-dev", "qa-engineer", "devops", "tech-writer"]
      }
    },
    "history": {
      "type": "array",
      "description": "Audit trail of all significant actions",
      "items": {
        "$ref": "#/definitions/HistoryEntry"
      }
    },
    "metrics": {
      "$ref": "#/definitions/Metrics",
      "description": "Execution metrics for retrospectives"
    },
    "blockedReason": {
      "type": "string",
      "description": "Explanation when status is 'blocked'"
    },
    "createdAt": {
      "type": "string",
      "format": "date-time",
      "description": "When the story was created"
    },
    "completedAt": {
      "type": "string",
      "format": "date-time",
      "description": "When the story was completed"
    }
  },
  "definitions": {
    "Context": {
      "type": "object",
      "description": "Business context that survives compaction",
      "required": ["why"],
      "properties": {
        "why": {
          "type": "string",
          "description": "Business reason for this story - the value proposition",
          "minLength": 20
        },
        "background": {
          "type": "string",
          "description": "Technical or historical background information"
        },
        "userRequest": {
          "type": "string",
          "description": "Original user request that triggered this story"
        },
        "relatedStories": {
          "type": "array",
          "description": "IDs of related stories for context",
          "items": {
            "type": "string",
            "pattern": "^[A-Z]+-[0-9]{3}$"
          }
        }
      }
    },
    "AcceptanceCriterion": {
      "type": "object",
      "description": "Single testable acceptance criterion",
      "required": ["id", "description", "status"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique AC identifier",
          "pattern": "^AC-[0-9]{3}$",
          "examples": ["AC-001", "AC-002"]
        },
        "description": {
          "type": "string",
          "description": "What must be true for this criterion to pass",
          "minLength": 10
        },
        "status": {
          "type": "string",
          "description": "Verification status",
          "enum": ["pending", "passed", "failed"]
        },
        "verifiedBy": {
          "type": "string",
          "description": "Actor who verified this criterion",
          "enum": ["architect", "backend-dev", "frontend-dev", "qa-engineer", "devops", "tech-writer"]
        },
        "verifiedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When verification occurred"
        },
        "evidence": {
          "type": "string",
          "description": "Reference to test or proof (e.g., test-log.md#ac-001)"
        }
      }
    },
    "Task": {
      "type": "object",
      "description": "Atomic unit of work that can be completed in one agent session",
      "required": ["id", "title", "status", "assignedTo"],
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique task identifier",
          "pattern": "^T-[0-9]{3}$",
          "examples": ["T-001", "T-042"]
        },
        "title": {
          "type": "string",
          "description": "Brief description of the task",
          "minLength": 5,
          "maxLength": 100
        },
        "status": {
          "type": "string",
          "description": "Task execution status",
          "enum": ["pending", "in-progress", "completed", "failed", "blocked"]
        },
        "assignedTo": {
          "type": "string",
          "description": "Actor type responsible for this task",
          "enum": ["architect", "backend-dev", "frontend-dev", "qa-engineer", "devops", "tech-writer"]
        },
        "dependencies": {
          "type": "array",
          "description": "Task IDs that must complete before this task can start",
          "items": {
            "type": "string",
            "pattern": "^T-[0-9]{3}$"
          },
          "default": []
        },
        "acCoverage": {
          "type": "array",
          "description": "Acceptance criteria IDs this task helps satisfy",
          "items": {
            "type": "string",
            "pattern": "^AC-[0-9]{3}$"
          }
        },
        "phase": {
          "type": "integer",
          "minimum": 1,
          "description": "Execution phase (computed from dependencies)"
        },
        "attemptCount": {
          "type": "integer",
          "minimum": 0,
          "maximum": 3,
          "default": 0,
          "description": "Number of execution attempts"
        },
        "startedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When execution began"
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When execution completed"
        },
        "failureReason": {
          "type": "string",
          "description": "Explanation if task failed"
        },
        "deliverables": {
          "type": "array",
          "description": "Expected outputs from this task",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "ActorSection": {
      "type": "object",
      "description": "Handoff section for a specific actor type",
      "required": ["status"],
      "properties": {
        "status": {
          "type": "string",
          "description": "Actor's work status on this story",
          "enum": ["not-started", "in-progress", "completed", "blocked"]
        },
        "completedAt": {
          "type": "string",
          "format": "date-time",
          "description": "When actor completed their work"
        },
        "notes": {
          "type": "string",
          "description": "General notes and context from the actor"
        },
        "designDecisions": {
          "type": "array",
          "description": "Key design decisions made (architect)",
          "items": {
            "type": "string"
          }
        },
        "apiContract": {
          "type": "object",
          "description": "API contract defined (architect) or implemented (backend-dev)",
          "additionalProperties": true
        },
        "filesCreated": {
          "type": "array",
          "description": "Files created or modified by this actor",
          "items": {
            "type": "string"
          }
        },
        "apiImplemented": {
          "type": "object",
          "description": "API endpoints implemented with status",
          "additionalProperties": {
            "type": "string"
          }
        },
        "testsWritten": {
          "type": "array",
          "description": "Test files written (qa-engineer)",
          "items": {
            "type": "string"
          }
        },
        "acceptanceCriteriaResults": {
          "type": "object",
          "description": "AC verification results (qa-engineer)",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "status": {
                "type": "string",
                "enum": ["pass", "fail", "skip"]
              },
              "evidence": {
                "type": "string"
              }
            },
            "required": ["status"]
          }
        },
        "bugsFound": {
          "type": "array",
          "description": "Bugs discovered during QA",
          "items": {
            "type": "object",
            "properties": {
              "description": { "type": "string" },
              "severity": { "type": "string", "enum": ["critical", "major", "minor"] },
              "status": { "type": "string", "enum": ["open", "fixed", "wontfix"] }
            },
            "required": ["description", "severity", "status"]
          }
        },
        "knownGaps": {
          "type": "array",
          "description": "Known limitations or gaps in the implementation",
          "items": {
            "type": "string"
          }
        },
        "handoffToFrontend": {
          "type": "string",
          "description": "Explicit handoff notes for frontend-dev"
        },
        "handoffToQA": {
          "type": "string",
          "description": "Explicit handoff notes for qa-engineer"
        },
        "handoffToBackend": {
          "type": "string",
          "description": "Explicit handoff notes for backend-dev"
        },
        "weaveProposals": {
          "type": "array",
          "description": "Knowledge discoveries to propose for Weave",
          "items": {
            "$ref": "#/definitions/WeaveProposal"
          },
          "default": []
        }
      }
    },
    "WeaveProposal": {
      "type": "object",
      "description": "Proposed knowledge discovery to commit to Weave",
      "required": ["dimension", "type", "id", "summary", "confidence"],
      "properties": {
        "dimension": {
          "type": "string",
          "description": "Weave knowledge dimension",
          "enum": ["E", "Q", "O", "M", "C", "A", "T", "H", "P", "MU", "D"],
          "enumDescriptions": {
            "E": "Epistemology - patterns, validated knowledge",
            "Q": "Qualia - pain points, experiences, workflows",
            "O": "Ontology - entity definitions, relationships",
            "M": "Mereology - part-whole relationships",
            "C": "Causation - cause-effect chains",
            "A": "Axiology - value judgments, tradeoffs",
            "T": "Teleology - purposes, goals",
            "H": "History - evolution, timelines",
            "P": "Praxeology - best practices, what worked",
            "MU": "Modality - alternatives, decisions",
            "D": "Deontics - obligations, permissions"
          }
        },
        "type": {
          "type": "string",
          "description": "Entity type within the dimension",
          "examples": ["pattern", "painpoint", "entity", "bestpractice", "decision"]
        },
        "id": {
          "type": "string",
          "description": "Kebab-case identifier for the knowledge",
          "pattern": "^[a-z][a-z0-9-]*$",
          "examples": ["type-handler-registry", "409-conflict-handling"]
        },
        "summary": {
          "type": "string",
          "description": "One-line summary of the discovery",
          "maxLength": 200
        },
        "detail": {
          "type": "string",
          "description": "Full explanation with context"
        },
        "confidence": {
          "type": "number",
          "description": "Confidence level (0.0 to 1.0)",
          "minimum": 0,
          "maximum": 1
        },
        "evidence": {
          "type": "string",
          "description": "File path or description supporting this proposal"
        }
      }
    },
    "HistoryEntry": {
      "type": "object",
      "description": "Audit trail entry for significant actions",
      "required": ["timestamp", "actor", "action", "summary"],
      "properties": {
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "When the action occurred"
        },
        "actor": {
          "type": "string",
          "description": "Who performed the action",
          "enum": ["stage-manager", "architect", "backend-dev", "frontend-dev", "qa-engineer", "devops", "tech-writer", "user"]
        },
        "action": {
          "type": "string",
          "description": "Type of action performed",
          "enum": [
            "story_created",
            "story_started",
            "story_completed",
            "story_blocked",
            "design_completed",
            "implementation_completed",
            "tests_completed",
            "task_completed",
            "task_failed",
            "task_retried",
            "ac_verified",
            "weave_enriched",
            "checkpoint_saved",
            "actor_spawned",
            "handoff_recorded"
          ]
        },
        "summary": {
          "type": "string",
          "description": "Human-readable description of what happened"
        },
        "details": {
          "type": "object",
          "description": "Additional structured details about the action",
          "additionalProperties": true
        }
      }
    },
    "Metrics": {
      "type": "object",
      "description": "Execution metrics for retrospectives and tracking",
      "properties": {
        "totalTasks": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of tasks in the story"
        },
        "tasksAtomicComplete": {
          "type": "integer",
          "minimum": 0,
          "description": "Tasks completed in first attempt"
        },
        "tasksRequiredRetry": {
          "type": "integer",
          "minimum": 0,
          "description": "Tasks that needed retry attempts"
        },
        "circuitBreakerTriggered": {
          "type": "integer",
          "minimum": 0,
          "description": "Tasks that hit 3-strike circuit breaker"
        },
        "totalActorSpawns": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of actor agents spawned"
        },
        "avgBootupTokens": {
          "type": "integer",
          "minimum": 0,
          "description": "Average tokens consumed by boot-up ritual"
        },
        "compactionRecoveries": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of times execution recovered from compaction"
        },
        "parallelPhases": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of phases with parallel task execution"
        },
        "elapsedTimeMinutes": {
          "type": "number",
          "minimum": 0,
          "description": "Total elapsed time from start to completion"
        }
      }
    }
  },
  "examples": [
    {
      "id": "US-014",
      "title": "Batch/WorkItem Semantic Separation",
      "status": "completed",
      "priority": "P0",
      "feature": "CRM",
      "context": {
        "why": "Users need distinct concepts for bulk operations vs individual work items to improve clarity and reduce confusion",
        "background": "CrmTask was overloaded - used for both batch operations and individual assignments",
        "userRequest": "Original request from user on 2025-12-08 to separate task types"
      },
      "acceptanceCriteria": [
        {
          "id": "AC-001",
          "description": "CrmTask renamed to CrmBatch in schema",
          "status": "passed",
          "verifiedBy": "qa-engineer",
          "verifiedAt": "2025-12-08T17:00:00Z",
          "evidence": "test-log.md#ac-001"
        }
      ],
      "tasks": [
        {
          "id": "T-001",
          "title": "Rename CrmTask schema to CrmBatch",
          "status": "completed",
          "assignedTo": "backend-dev",
          "dependencies": [],
          "acCoverage": ["AC-001"],
          "phase": 1,
          "attemptCount": 1,
          "completedAt": "2025-12-08T14:00:00Z"
        }
      ],
      "actorSections": {
        "architect": {
          "status": "completed",
          "completedAt": "2025-12-08T10:00:00Z",
          "designDecisions": [
            "Chose 'WorkItem' over 'Task' for clarity",
            "Separate module for WorkItems vs inline in CRM"
          ],
          "notes": "WorkItem is single-entity, Batch is bulk. Never mix.",
          "weaveProposals": []
        },
        "backend-dev": {
          "status": "completed",
          "completedAt": "2025-12-08T14:00:00Z",
          "filesCreated": [
            "packages/db/src/schema/work-items.ts"
          ],
          "notes": "Used TypeHandler pattern for extensibility.",
          "handoffToQA": "Test claim/complete flow. Check 409 on double-claim.",
          "weaveProposals": [
            {
              "dimension": "E",
              "type": "pattern",
              "id": "type-handler-registry",
              "summary": "Use TypeHandler pattern for extensible work item types",
              "detail": "Register handlers by workItemType string. Each handler implements execute().",
              "confidence": 0.85,
              "evidence": "apps/api/src/modules/work-items/handlers/"
            }
          ]
        },
        "qa-engineer": {
          "status": "completed",
          "completedAt": "2025-12-08T17:00:00Z",
          "testsWritten": ["test/e2e/work-items-crud.spec.ts"],
          "acceptanceCriteriaResults": {
            "AC-001": { "status": "pass", "evidence": "test-log.md#ac-001" }
          },
          "bugsFound": [],
          "weaveProposals": []
        }
      },
      "history": [
        {
          "timestamp": "2025-12-08T09:00:00Z",
          "actor": "stage-manager",
          "action": "story_created",
          "summary": "Created from user request for task/batch separation"
        },
        {
          "timestamp": "2025-12-08T10:00:00Z",
          "actor": "architect",
          "action": "design_completed",
          "summary": "Designed WorkItem system, chose naming, defined API contract"
        },
        {
          "timestamp": "2025-12-08T18:00:00Z",
          "actor": "stage-manager",
          "action": "weave_enriched",
          "summary": "Indexed 1 discovery: E:type-handler-registry"
        }
      ],
      "metrics": {
        "totalTasks": 3,
        "tasksAtomicComplete": 3,
        "tasksRequiredRetry": 0,
        "circuitBreakerTriggered": 0,
        "totalActorSpawns": 3,
        "avgBootupTokens": 1523,
        "compactionRecoveries": 0,
        "parallelPhases": 1,
        "elapsedTimeMinutes": 540
      },
      "createdAt": "2025-12-08T09:00:00Z",
      "completedAt": "2025-12-08T18:00:00Z"
    }
  ]
}
